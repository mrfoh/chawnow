Backend.Views.RestuarantFormView=Backbone.View.extend({el:"#app",ui:{form:"#user-form",logopreview:".logo-thumbnail",city:"#city",area:"#area",logistics:"#logistics-info"},events:{"change #city":"onCityChange","change #deliveries":"onDeliveriesChange","change #pickups":"onPickupChange","click .remove-trigger":"removeLogo","click #upload-btn":"uploadLogo"},validationRules:{name:{required:!0},address:{required:!0},minimuim_order:{required:!0,number:!0},email:{required:!0,email:!0},phone:{required:!0,number:!0},delivery_fee:{number:!0}},setUpUi:function(){var a=this;_.each(_.keys(a.ui),function(b){var c=a.ui[b];this.ui[b]=$(c)},this)},initUploader:function(){var a=new plupload.Uploader({runtimes:"html5,flash",browse_button:"upload-trigger",url:Backend.Constants.url+"/upload",max_file_size:"1mb",filters:[{title:"Image files",extensions:"jpg,gif,png"}],flash_swf_url:Backend.Constants.url+"/js/plugins/plupload/Moxie.swf",unique_names:!0,file_data_name:"logo"});this.uploader=a,this.uploader.init(),this.uploader.bind("FilesAdded",this.logoAdded,this),this.uploader.bind("FileUploaded",this.logoUploaded,this)},logoAdded:function(a,b){var c=$(".logo-thumbnail"),d=c.find(".remove-trigger"),e=$("#upload-btn");c.find("canvas").remove(),c.find("img").remove(),e.show(),$.each(b,function(){var a=new mOxie.Image;a.onload=function(){this.embed(c.get(0),{width:300,height:200,crop:!1})},a.onembedded=function(){this.destroy()},a.onerror=function(){this.destroy()},a.load(this.getSource())}),d.show()},logoUploaded:function(a,b,c){var d=$.parseJSON(c.response);"success"==d.status&&($("#upload-btn").html('<i class="icon-cloud-upload"></i> Uploaded').delay(3e3).hide(),$("#upload-btn").html('<i class="icon-cloud-upload"></i> Upload'),$("input#logo").val(d.file.path))},initialize:function(){this.setUpUi(),this.initUploader(),this.bindPlugins(),this.cities=new Backbone.Collection,this.cities.reset(locales),this.populateCityDropdown()},bindFormValidation:function(){this.ui.form.validate({rules:this.validationRules,onfocusout:function(a){$(a).valid()},errorPlacement:function(a,b){$('<span class="error"></span>').insertAfter(b).append(a);var c=$(b).parent(".controls");c.removeClass("success-control").addClass("error-control")},success:function(a,b){var c=$(b).parent(".controls");c.removeClass("error-control").addClass("success-control")},submitHandler:function(a){a.submit()}})},bindPlugins:function(){$(".timepicker-default").timepicker(),this.bindFormValidation();var a=$("#deliveries"),b=$("#pickups");if("1"==a.attr("data-checked")){var c=$("#delivery-info");a.prop("checked",!0),this.ui.logistics.show(),c.show()}if("1"==b.attr("data-checked")){var c=$("#pickup-info");b.prop("checked",!0),this.ui.logistics.show(),c.show()}},onCityChange:function(a){var b=$(a.currentTarget),c=b.val(),d=this.cities.get(c);areas=d.get("areas"),this.populateAreaDropdown(areas)},populateCityDropdown:function(){var a=this;if(this.cities.each(function(b){a.ui.city.append('<option value="'+b.id+'">'+b.get("name")+"</option>")}),"none"!=this.ui.city.attr("data-select")){{var b=this.ui.city.attr("data-select");this.ui.city.find('option[value="'+b+'"]').prop("selected",!0)}city=this.cities.get(b),areas=city.get("areas"),this.populateAreaDropdown(areas)}},populateAreaDropdown:function(a){var b=this;if(this.ui.area.removeAttr("disabled"),_.each(a,function(a){b.ui.area.append('<option value="'+a.id+'">'+a.name+"</option>")}),"none"!=this.ui.area.attr("data-select")){var c=this.ui.area.attr("data-select");this.ui.area.find('option[value="'+c+'"]').prop("selected",!0)}},onDeliveriesChange:function(a){var b=$(a.currentTarget),c=$("#delivery-info"),d=$("#pickups");b.prop("checked")?(c.show(),this.ui.logistics.is(":visible")||this.ui.logistics.slideDown()):(c.hide(),d.prop("checked")||this.ui.logistics.slideUp())},onPickupChange:function(a){var b=$(a.currentTarget),c=$("#pickup-info"),d=$("#deliveries");b.prop("checked")?(c.show(),this.ui.logistics.is(":visible")||this.ui.logistics.slideDown()):(c.hide(),d.prop("checked")||this.ui.logistics.slideUp())},removeLogo:function(a){var b=$(a.currentTarget);"true"==b.attr("data-hide")?b.hide():this.ui.logopreview.find("a.remove-trigger").hide(),$("#upload-btn").hide(),this.ui.logopreview.find("canvas").remove(),this.ui.logopreview.find("img").remove(),$("#logo").val(""),a.preventDefault()},uploadLogo:function(a){var b=$(a.currentTarget);b.html('<i class="icon-cloud-upload"></i> Uploading...'),b.attr("disabled","disabled"),this.uploader.start()}});